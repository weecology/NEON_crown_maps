---
title: "Height_Distributions"
author: "Ben Weinstein"
date: "3/10/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(sf)
library(raster)
library(dplyr)
library(ggplot2)
library(tidyr)
library(stringr)
```

```{r}
#shps<-list.files("/Users/ben/Dropbox/Weecology/Crowns/examples/",pattern=".shp",full.names=T)
shps<-list.files("/orange/ewhite/b.weinstein/NEON/draped/",pattern=".shp",full.names=T)

shps<-sample(shps,500)

shps<-lapply(shps,function(x){
  r<-data.frame(read_sf(x))
  r$Year<-str_match(x,"(\\d+)_\\w+_\\d_\\d+_\\d+_image.shp")[,2]
  r$Site<-str_match(x,"\\d+_(\\w+)_\\d_\\d+_\\d+_image.shp")[,2]
  
  r$Tile<-x
  
  r$geo_index<-str_match(x,"\\d+_\\w+_\\d_(\\d+_\\d+)_image.shp")[,2]
  
  return(r)
})

df<-do.call(rbind,shps)
```

## Crown Height

```{r}
df %>% filter(Year=="2019") %>% ggplot(.,aes(x=height)) + geom_density(alpha=0.5,fill="black")  + labs(x="99th quantile Crown Height (m)")  + theme_bw() + facet_wrap(~Site) 
ggsave("/home/b.weinstein/NEON_crown_maps/Figures/Site_Height.svg",height=8,width=11)
```

## Crown Area

```{r}
df %>% filter(Year=="2019") %>% ggplot(.,aes(x=height,fill=Site)) + geom_density(alpha=0.9)  + labs(x="99th quantile Crown Height (m)")  + theme_bw()
ggsave("/home/b.weinstein/NEON_crown_maps/Figures/Crown_Area.svg",height=8,width=11)
```

## Biplot
```{r}
crown_area<-df %>% filter(Year=="2019") %>% group_by(Site) %>% dplyr::summarize(crown_area=mean(area),var_crown=var(area))

site_density<-df %>% filter(Year=="2019") %>% group_by(Site,geo_index) %>% dplyr::summarize(n=n()) %>% group_by(Site) %>% dplyr::summarise(density = sum(n)/n()) 

height<-df %>% filter(Year=="2019") %>% group_by(Site) %>% summarize(mean_height=mean(height),var_height=var(height,na.rm = T))

site_df<-merge(merge(crown_area,site_density),height)
rownames(site_df)<-site_df[,1]
pc<-prcomp(site_df[,c("mean_height","crown_area","density")],scale=T)
ggbiplot::ggbiplot(pc,labels = site_df[,1])
ggsave("/home/b.weinstein/NEON_crown_maps/Figures/biplot.svg", height=7,width = 10)
```

### Over time
```{r}
ggplot(df,aes(x=height,fill=Year)) + geom_density(alpha=0.9)  + labs(x="99th quantile Crown Height (m)") + facet_wrap(~Site,scales="free") + theme_bw()
ggsave("/home/b.weinstein/NEON_crown_maps/Figures/TimeHeight_example.png",height=6,width=9)
```

## Counts over time

```{r}
ydf<-df %>% group_by(Site,geo_index,Year) %>% dplyr::summarize(n=n()) %>% spread(Year,n)
ggplot(ydf,aes(x=`2019`,y=`2018`)) + geom_point() + geom_abline() + coord_fixed()
ggsave("/home/b.weinstein/NEON_crown_maps/Figures/Counts.png",height=6,width=9)
```
