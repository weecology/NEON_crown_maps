} else{
plot_result<-list()
for(subplot in subplots){
projected_subplot<-projected_field %>% filter(subplotID==subplot)
plot_result[[subplot]]<-count_trees(field_data=projected_subplot,CHM_images = CHM_images,predictions=project_prediction,show=T,rgb_images=rgb_images) %>% mutate(plotID=plot_name,subplot=subplot)
}
results[[plot_name]]<- bind_rows(plot_result)
}
}
results<-bind_rows(results)
# Chunk 8
ggplot(results,aes(x=field,y=rs)) + geom_point() + stat_smooth(method="lm") + geom_abline(linetype="dashed") + labs(x="Field Stems",y="Remotely Sensed Crowns")
# Chunk 9
results %>% mutate(Site = str_match(plotID,"(\\w+)_")[,2]) %>% ggplot(.,aes(x=field,y=rs)) + geom_point() + stat_smooth(method="lm") + geom_abline(linetype="dashed") + labs(x="Field Stems",y="Remotely Sensed Crowns") + facet_wrap(~Site,scales="free")
# Chunk 10
field %>% group_by(plotID) %>% dplyr::select(plotID,plotType) %>% distinct() %>% inner_join(results) %>% mutate(Site = str_match(plotID,"(\\w+)_")[,2]) %>% ggplot(.,aes(x=field,y=rs,col=plotType)) + geom_point() + stat_smooth(method="lm") + geom_abline(linetype="dashed") + labs(x="Field Stems",y="Remotely Sensed Crowns") + facet_wrap(~Site,scales="free")
# Chunk 11
results %>% mutate(error=rs-field) %>% arrange(desc(error))
# Chunk 1: setup
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(lme4)
library(dplyr)
library(NeonTreeEvaluation)
library(stringr)
library(sf)
library(raster)
# Chunk 2
#Read submission and turn into geospatial objects
submission<-read.csv("plot_predictions.csv")
#UNDE should be dropped from the height dataset, LIDAR isn't trustworthy.
submission<-submission %>% filter(!str_detect(plot_name,"UNDE"))
RGB_DIR<-"/Users/Ben/Documents/NeonTreeEvaluation/evaluation/RGB/"
rgb_images<-list.files(RGB_DIR,".tif",full.names = T)
rgb_images<-rgb_images[!str_detect(rgb_images,".xml")]
CHM_DIR<-"/Users/Ben/Documents/NeonTreeEvaluation/evaluation/CHM/"
CHM_images<-list.files(CHM_DIR,".tif",full.names = T)
CHM_images<-CHM_images[!str_detect(CHM_images,".xml")]
# Chunk 3
field<-read.csv("/Users/ben/Documents/NEON_crown_maps/Figures/vst_field_data.csv")
field$area<-field$maxCrownDiameter*field$ninetyCrownDiameter
field<-field %>%  filter(!is.na(itcEasting),!str_detect(eventID,"2014"),growthForm %in% c("single bole tree","multi-bole tree","small tree","sapling"),stemDiameter>15) %>% droplevels() %>% filter(height>3|is.na(height))
#field<-field %>% group_by(individualID) %>% arrange(desc(eventID)) %>% slice(1)
#Limit difference in heights
to_remove<-field %>% group_by(individualID) %>% summarize(mean=mean(height),sum_difference = abs(sum(diff(height)))) %>% filter(sum_difference > 8)
field<-field %>% filter(!individualID %in% to_remove$individualID)
# Chunk 4
matched_pairs<-function(spatial_boxes,field_points){
#Spatial join
possible_matches<-st_join(spatial_boxes,field_points,left=FALSE)
#If there are heights, take the tallest height
tallest_points<-possible_matches %>% group_by(crown_id) %>% mutate(height_diff=height.x - height.y) %>%arrange(height_diff) %>% slice(1)  %>% as.data.frame()%>% dplyr::select(crown_id, individualID)
matched_height<-possible_matches %>% inner_join(tallest_points)
return(matched_height)
}
# Chunk 5
site_plots<-field %>% group_by(plotID,individualID)  %>% summarize(samples=length(unique(eventID))) %>% filter(samples>1) %>% ungroup() %>% mutate(plotID=as.character(plotID))
results<-list()
for(x in unique(site_plots$plotID)){
print(x)
#x<-"OSBS_022"
#matching RGB tile
rgb_path<-rgb_images[str_detect(rgb_images,x)]
if(length(rgb_path)==0){next}
r<-raster::stack(rgb_path)
#Field data, min height threshold is 3.
field_points<-field %>% filter(plotID==x) %>% st_as_sf(.,coords=c("itcEasting","itcNorthing")) %>% filter(height>3)
st_crs(field_points)<-crs(r)
predictions<-submission %>% filter(plot_name==x)
if(nrow(predictions)==0){next}
spatial_boxes<- predictions %>% NeonTreeEvaluation::boxes_to_spatial_polygons(.,r) %>% st_as_sf() %>% mutate(height=predictions$height, score=predictions$score)
#Filter the field data for erroneous temporal connections, the CHM must have positive heights, see OSBS_022, can use as an example of all sorts of challenges.
CHM_path<-CHM_images[str_detect(CHM_images,x)]
chm<-raster(CHM_path)
#Thresholds
field_points$CHM_height<-extract(chm,field_points)
#Could it be seen?
field_points<-field_points %>% filter(abs(CHM_height-height)<4)
#Min height based on the predictions
#field_points<-field_points[field_points$height > quantile(spatial_boxes$height,0.01),]
plotRGB(r)
plot(st_geometry(spatial_boxes),add=T)
plot(st_geometry(field_points),add=T,col="red",pch=20)
#Missing
missing<-field_points[!lengths(st_intersects(field_points, spatial_boxes)), ]
plot(st_geometry(missing),add=T,col="blue",pch=20)
#Stem recall rate
unique_locations<-field_points %>% distinct(individualID,.keep_all = T)
tree_in_prediction <-unique_locations  %>% sf::st_intersects(x=.,y=spatial_boxes)
#Which match, do not allow multiples to double count.
matches<-lengths(tree_in_prediction)
matches[matches>1]<-1
stem_recall<-sum(matches)/nrow(unique_locations)
#unique matches
joined_df<-st_join(spatial_boxes,unique_locations)
single_matches<-joined_df %>% group_by(crown_id) %>% filter(height.y == max(height.y))
single_recall<-nrow(single_matches)/nrow(unique_locations)
#Create point matches between data and predictions
matched_df<-matched_pairs(spatial_boxes, field_points) %>% mutate(plot_name=x)
if(nrow(matched_df)>0){
results[[x]]<-data.frame(matched_df,stem_recall,single_recall)
}
}
results<-bind_rows(results)
# Chunk 6
#Show difference
# CLBJ has 3 data points.drop
height_summary<-results  %>% filter(!siteID %in% "CLBJ") %>% mutate(Site=str_match(plot_name,"(\\w+)_")[,2]) %>% group_by(Site,plot_name,individualID,crown_id) %>%  summarize(predicted_height=unique(height.x)[1],mean_field=mean(height.y),min_field=min(height.y),max_field=max(height.y)) %>% mutate(field_range=max_field - min_field)
ggplot(height_summary,aes(x=predicted_height,y=mean_field,ymin=min_field,ymax=max_field)) + geom_pointrange(size=0.1,alpha=0.5) + geom_abline(linetype="dashed") + coord_flip() + labs(y="Field Height (m)",x="Predicted Height (m)")  + stat_smooth(method="lm")  + facet_wrap(~Site,scales="free")
ggsave("Height_Comparison.png",height=7,width=10)
ggplot(height_summary,aes(x=field_range)) + geom_density(fill="black") + facet_wrap(~Site,scales="free") + labs(x="Height difference (m) among years for the same ID")
ggplot(height_summary,aes(x=mean_field,y=field_range)) + geom_point() + labs(x="Mean Field Height",y="Range of Heights")
# Chunk 7
mod<-lmer(data=height_summary,mean_field~predicted_height|Site)
sqrt(mean(residuals(mod)^2))
# Chunk 8
height_summary %>% mutate(error=abs(mean_field - predicted_height)) %>% group_by(Site) %>% filter(error==max(error)) %>% arrange(desc(error)) %>% as.data.frame()
#   ylim(min(c(min(height_summary$min_field,height_summary$predicted_height))),max(c(height_summary$predicted_height,height_summary$max_field))) + xlim(min(c(min(height_summary$min_field,height_summary$predicted_height))),max(c(height_summary$predicted_height,height_summary$max_field)))
# Chunk 9
#order by mean
order_site<-results %>% group_by(siteID) %>% summarize(mean=mean(stem_recall)) %>% arrange(desc(mean)) %>% .$siteID
recall_data<-results %>% group_by(plot_name,crown_id) %>% arrange(desc(eventID)) %>% slice(1) %>% group_by(siteID,plot_name)  %>% distinct(stem_recall, single_recall) %>% ungroup() %>% mutate(siteID=factor(siteID,order_site))
recall_data_melt<-reshape2::melt(recall_data,id.vars=c("siteID","plot_name"))
levels(recall_data_melt$variable)<-c("All Matches","Unique Matches")
recall_data_melt%>% ggplot(.,aes(x=siteID,y=value,fill=variable)) + geom_boxplot(alpha=0.6) + theme_bw() + scale_y_continuous("Field Stem Recall (%)", label=scales::percent,limits = c(0,1)) + coord_flip() + labs(x="Site")
ggsave("SiteStemRecall.svg",height=5,width=6)
ggsave("SiteStemRecall.png",height=5,width=6)
recall_data%>% ggplot(.,aes(x=siteID,y=single_recall)) + geom_boxplot(alpha=0.6) + theme_bw() + scale_y_continuous("Field Stem Recall (%)", label=scales::percent,limits = c(0,1)) + coord_flip() + labs(x="Site")
ggsave("SiteStemRecall_unique.png",height=5,width=6)
ggsave("SiteStemRecall_unique.svg",height=5,width=6)
results %>% group_by(plot_name,crown_id) %>% arrange(desc(eventID)) %>% slice(1) %>% group_by(siteID)%>% summarize(stem_recall=mean(stem_recall))
results %>% group_by(plot_name,crown_id) %>% arrange(desc(eventID)) %>% slice(1) %>% ungroup() %>% summarize(stem_recall=mean(stem_recall),single_recall=mean(single_recall))
library(raster)
library(dplyr)
library(ggplot2)
library(scales)
library(tidyr)
library(stringr)
df<-read.csv("averages.csv",row.names =1)
counts<-read.csv("counts.csv")
colnames(counts)<-c("Site","geo_index","Year","n")
counts %>% group_by(Site, Year) %>% summarize(n=sum(n)) %>% filter(Year==max(Year)) %>% ungroup() %>% summarize(sum(n))
counts %>% group_by(Site, Year) %>% summarize(n=sum(n)) %>% filter(Year==max(Year)) %>% data.frame()
counts %>% group_by(Site) %>% summarize(n=sum(n)) %>% data.frame()
library(NeonTreeEvaluation)
r<-get_data("OSBS_008","lidar")
library(lidR)
plot(readLAS(r))
plot(readLAS(r))
plot(canopy_model(r))
plot(canopy_model(readLAS(r)))
plot(canopy_model(readLAS(r))>3)
library(raster)
list.files("/Users/ben/Documents/NeonTreeEvaluation/evaluation/RGB/",pattern="competition")
images<-list.files("/Users/ben/Documents/NeonTreeEvaluation/evaluation/RGB/",pattern="competition")
image<-images[0]
stack(image)
image<-images[30]
stack(image)
images<-list.files("/Users/ben/Documents/NeonTreeEvaluation/evaluation/RGB/",pattern="competition",full.names = T)
stack(image)
image<-images[30]
stack(image)
writeRaster(r,"/Users/Ben/Desktop/test.tif",datatype='INT1U',overwrite=T)
r
r<-stack(image)
writeRaster(r,"/Users/Ben/Desktop/test.tif",datatype='INT1U',overwrite=T)
library(raster)
images<-list.files("/Users/ben/Documents/NeonTreeEvaluation/evaluation/RGB/",pattern="competition",full.names = T)
for(image in images){
r<-stack(image)
writeRaster(r,image,datatype='INT1U',overwrite=T)
}
library(ggplot2)
library(scales)
library(dplyr)
library(rstanarm)
library(tidybayes)
library(tidyr)
library(stringr)
library(broom)
#Load data from HPC
f<-list.files(pattern="sampling")
f<-f[str_detect(f,"nlcd")]
sampling<-bind_rows(lapply(f,read.csv))
f
file.remove("")
read.csv("sampling_WOOD_nlcd.csv")
head(lapply(f,read.csv))
sampling<-bind_rows(lapply(f,read.csv))
warnings()
a<-read.csv("sampling_WOOD_nlcd.csv")
a$nlcd
unique(a$nlcd)
as.factor(a$nlcd)
#Load data from HPC
f<-list.files(pattern="sampling")
f<-f[str_detect(f,"nlcd")]
fn<-lapply(f,read.csv)
#rename as character
fn<-lapply(function(x){
x$nlcd<-as.character(x$nlcd)}
return(x)
)
#rename as character
fn<-lapply(function(x){
x$nlcd<-as.character(x$nlcd)
return(x)
})
#rename as character
fn<-lapply(fn, function(x){
x$nlcd<-as.character(x$nlcd)
return(x)
})
hed(fn)
hed(gn)
head(fn)
sampling<-bind_rows(lapply(fn,read.csv))
sampling<-bind_rows(fn)
#remove nlcd classes
to_remove<- sampling %>% filter(nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
to_remove
table(to_remove$site)
head(to_remove)
ggplot(to_remove,aes(x=tree_density)) + geom_histogram()
ggplot(to_remove,aes(x=tree_density)) + geom_histogram(fill=nlcd)
ggplot(to_remove,aes(x=tree_density)) + geom_histogram(aes(fill=nlcd))
ggplot(to_remove,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot(sampling,aes(x=nlcd, y=tree_density)) + geom_boxplot()
sampling<- sampling %>% filter(!nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
#Plot sampling curves
p <- ggplot() + geom_density(data=sampling,aes(x=tree_density,fill=as.factor(year)),alpha=0.4) + facet_wrap(~site,scales="free") + labs(fill="year")
#Get site curve
field_density<-field %>% filter(siteID %in% results$Site) %>% group_by(site=siteID,plotID,eventID) %>% summarize(n=n()) %>% summarize(tree_density=round(mean(n)))
# Chunk 1: setup
library(ggplot2)
library(scales)
library(dplyr)
library(rstanarm)
library(tidybayes)
library(tidyr)
library(stringr)
library(broom)
# Chunk 2
df<-read.csv("tile_averages.csv",row.names = 1)
colnames(df)[colnames(df) %in% "X0"]<-"count"
#mean across year
df<-df %>% group_by(Site,geo_index) %>% summarize(count=mean(count))
ggplot(df) + geom_density(aes(x=count)) + facet_wrap(~Site)
# Chunk 3
sample_data<-function(df, n=10){
df[sample(nrow(df),n),]
}
results<-list()
for(y in 1:200){
subtotal<-list()
for(x in seq(0.01,1,0.1)){
subtotal[[as.character(x)]]<-df %>% group_by(Site) %>% sample_frac(x) %>% summarize(total=sum(count)) %>% mutate(frac=x)
}
results[[y]]<-bind_rows(subtotal)
}
results<-bind_rows(results)
#Get sq km
sqkm<-df %>% group_by(Site) %>% summarize(n=n())
results<-merge(results,sqkm)
results<-results %>% mutate(sqkm=floor(frac*n))
#Summarize by fraction
results<-results %>% group_by(Site,sqkm) %>% summarize(mean=mean(total),lower=quantile(total,0.05),upper=quantile(total,0.95))
ggplot(results,aes(x=sqkm,y=mean)) +facet_wrap(~Site,scales="free") + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper)) + scale_y_continuous(label=comma) + labs(x="Extent (km^2)",y="Tree Count")
# Chunk 4
field<-read.csv("/Users/ben/Documents/NEON_crown_maps/Figures/vst_field_data.csv")
field$area<-field$maxCrownDiameter*field$ninetyCrownDiameter
field<-field %>%  filter(!is.na(itcEasting),!str_detect(eventID,"2014"),growthForm %in% c("single bole tree","multi-bole tree","small tree","sapling"),stemDiameter>15) %>% droplevels() %>% filter(height>3|is.na(height))
field<-field %>% group_by(individualID) %>% arrange(desc(eventID)) %>% slice(1)
# Chunk 5
#field %>% filter(siteID %in% results$Site) %>% filter(!is.na(easting)) %>% filter(stemDiameter < 8) %>% ggplot(.,aes(x=height,fill=siteID)) + geom_density(alpha=0.5)
# Chunk 6
#Scaling factor from a 40m plot to 1km tile
scaling=(1000 * 1000) /((20*20)*2)
#TODO plot type? Individual ID for multi-bole?
# plot_totals<-field %>% filter(siteID %in% results$Site) %>% filter(!is.na(itcEasting)) %>% filter(stemDiameter > 7.5) %>% filter(is.na(height)|height>3) %>% group_by(Site=siteID,plotID,eventID) %>% summarize(n=n()) %>% summarize(n=round(mean(n)))
stan_glm <- stan_glm(n~0 + Site,data = plot_totals,family = poisson,cores=4, iter=20000)
# Chunk 7
newdata <- results %>% group_by(Site,sqkm) %>% distinct() %>% dplyr::select(Site,sqkm) %>% filter(Site %in% plot_totals$Site)
estimated <- fitted_draws(stan_glm, newdata,draws=2000) %>% mutate(total=(sqkm * .value)*scaling)  %>% group_by(Site,sqkm,.draw) %>% summarize(total=sum(total)) %>% summarize(mean=mean(total),lower=quantile(total,0.05),upper=quantile(total,0.95))
ggplot(estimated,aes(x=sqkm,y=mean)) +facet_wrap(~Site,scales="free") + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper)) + scale_y_continuous(label=comma) + labs(x="Extent (km^2)",y="Tree Count")
#Combined
results$Data<-c("Remote Sensing")
estimated$Data<-c("Field")
combined<-bind_rows(list(results,estimated))
ggplot(combined,aes(x=sqkm,y=mean,fill=Data)) +facet_wrap(~Site,scales="free") + geom_line(col="black") + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + scale_y_continuous(label=comma) + labs(x="Extent (km^2)",y="Tree Count")  + theme_bw()
ggsave("Scaling_all.png",height=10,width=12)
combined %>% filter(Site %in% c("DSNY","TEAK","OSBS","BART","BLAN","SJER","MLBS","HARV","LENO")) %>% ggplot(. ,aes(x=sqkm,y=mean,fill=Data)) +facet_wrap(~Site,scales="free") + geom_line(col="black") + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + scale_y_continuous(label=comma) + labs(x="Extent (km^2)",y="Tree Count")  + theme_bw()
ggsave("Scaling_subset.png",height=7,width=10)
# Chunk 8
combined %>% group_by(Data,Site) %>% filter(sqkm == max(sqkm)) %>% ungroup() %>% pivot_wider(names_from=Data,values_from=c(mean,lower,upper)) %>% ggplot(., aes(x=mean_Field,y=`mean_Remote Sensing`)) + geom_point()  + labs(x="Field",y="Remote Sensing") + ggtitle("Tree Count") + geom_abline(linetype="dashed") + coord_fixed()    + geom_text(aes(label=Site),size=2,hjust=1.1,vjust=1.2) + theme_bw()  + scale_x_continuous(limits=c(0e7,1.74e7),labels=comma) + scale_y_continuous(limits=c(0e7,1.2e7),labels=comma) + geom_errorbarh(aes(xmin=lower_Field,xmax=upper_Field))
ggsave("FullSiteScale.png",height=6,width=9)
# Chunk 9
#Load data from HPC
f<-list.files(pattern="sampling")
f<-f[str_detect(f,"nlcd")]
fn<-lapply(f,read.csv)
#rename as character
fn<-lapply(fn, function(x){
x$nlcd<-as.character(x$nlcd)
return(x)
})
sampling<-bind_rows(fn)
#remove nlcd classes
to_remove<- sampling %>% filter(nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
ggplot(to_remove,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot(sampling,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot()
sampling<- sampling %>% filter(!nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
#Plot sampling curves
p <- ggplot() + geom_density(data=sampling,aes(x=tree_density,fill=as.factor(year)),alpha=0.4) + facet_wrap(~site,scales="free") + labs(fill="year")
#Get site curve
field_density<-field %>% filter(siteID %in% results$Site) %>% group_by(site=siteID,plotID,eventID) %>% summarize(n=n()) %>% summarize(tree_density=round(mean(n)))
rects<-field_density %>% group_by(site) %>% summarize(mean=mean(tree_density),lower=quantile(tree_density,0.05), upper=quantile(tree_density,0.95))
p +geom_rect(data=rects,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(data=rects,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot",fill="Year")
ggsave("sampling3.png",height=4,width=7)
rect_subset <- rects %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO"))
sampling %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>% group_by(site) %>% filter(year==max(year)) %>% ggplot(.) +
geom_density(aes(x=tree_density),fill="black",alpha=0.4) + facet_wrap(~site,scales="free") +geom_rect(data=rect_subset,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(aes(xintercept=mean(tree_density))) + geom_vline(data=rect_subset,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot")
ggsave("Sampling_subset.png",height=4,width=7)
#as a pair of distributions
field_density$data<-c("NEON Field Plots")
sampling$data<-c("Simulated RS Plots")
combined<-bind_rows(field_density,sampling) %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>%
ggplot(.,aes(x=tree_density,fill=data)) + geom_density(alpha=0.3) + facet_wrap(~site,scales="free") + labs(x="Trees per plot")
combined
ggsave("Sampling_distributions.png",height=4,width=7)
ggplot(to_remove,aes(x=nlcd, y=tree_density)) + geom_boxplot()
# Chunk 9
#Load data from HPC
f<-list.files(pattern="sampling")
f<-f[str_detect(f,"nlcd")]
fn<-lapply(f,read.csv)
#rename as character
fn<-lapply(fn, function(x){
x$nlcd<-as.character(x$nlcd)
return(x)
})
sampling<-bind_rows(fn)
#remove nlcd classes
to_remove<- sampling %>% filter(nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
ggplot(to_remove,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot(sampling,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot()
sampling<- sampling %>% filter(!nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
#Plot sampling curves
p <- ggplot() + geom_density(data=sampling,aes(x=tree_density,fill=as.factor(year)),alpha=0.4) + facet_wrap(~site,scales="free") + labs(fill="year")
#Get site curve
field_density<-field %>% filter(siteID %in% results$Site) %>% group_by(site=siteID,plotID,eventID) %>% summarize(n=n()) %>% summarize(tree_density=round(mean(n)))
rects<-field_density %>% group_by(site) %>% summarize(mean=mean(tree_density),lower=quantile(tree_density,0.05), upper=quantile(tree_density,0.95))
p +geom_rect(data=rects,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(data=rects,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot",fill="Year")
ggsave("sampling3.png",height=4,width=7)
rect_subset <- rects %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO"))
sampling %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>% group_by(site) %>% filter(year==max(year)) %>% ggplot(.) +
geom_density(aes(x=tree_density),fill="black",alpha=0.4) + facet_wrap(~site,scales="free") +geom_rect(data=rect_subset,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(aes(xintercept=mean(tree_density))) + geom_vline(data=rect_subset,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot")
ggsave("Sampling_subset.png",height=4,width=7)
#as a pair of distributions
field_density$data<-c("NEON Field Plots")
sampling$data<-c("Simulated RS Plots")
combined<-bind_rows(field_density,sampling) %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>%
ggplot(.,aes(x=tree_density,fill=data)) + geom_density(alpha=0.3) + facet_wrap(~site,scales="free") + labs(x="Trees per plot")
combined
ggsave("Sampling_distributions.png",height=4,width=7)
# Chunk 9
#Load data from HPC
f<-list.files(pattern="sampling")
f<-f[str_detect(f,"nlcd")]
fn<-lapply(f,read.csv)
#rename as character
fn<-lapply(fn, function(x){
x$nlcd<-as.character(x$nlcd)
return(x)
})
sampling<-bind_rows(fn)
#remove nlcd classes
to_remove<- sampling %>% filter(nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
ggplot(to_remove,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot(sampling,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot()
sampling<- sampling %>% filter(!nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
#Plot sampling curves
p <- ggplot() + geom_density(data=sampling,aes(x=tree_density,fill=as.factor(year)),alpha=0.4) + facet_wrap(~site,scales="free") + labs(fill="year")
#Get site curve
field_density<-field %>% filter(siteID %in% results$Site) %>% group_by(site=siteID,plotID,eventID) %>% summarize(n=n()) %>% summarize(tree_density=round(mean(n)))
rects<-field_density %>% group_by(site) %>% summarize(mean=mean(tree_density),lower=quantile(tree_density,0.05), upper=quantile(tree_density,0.95))
p +geom_rect(data=rects,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(data=rects,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot",fill="Year")
ggsave("sampling3.png",height=4,width=7)
rect_subset <- rects %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO"))
sampling %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>% group_by(site) %>% filter(year==max(year)) %>% ggplot(.) +
geom_density(aes(x=tree_density),fill="black",alpha=0.4) + facet_wrap(~site,scales="free") +geom_rect(data=rect_subset,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(aes(xintercept=mean(tree_density))) + geom_vline(data=rect_subset,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot")
ggsave("Sampling_subset.png",height=4,width=7)
#as a pair of distributions
field_density$data<-c("NEON Field Plots")
sampling$data<-c("Simulated RS Plots")
combined<-bind_rows(field_density,sampling) %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>%
ggplot(.,aes(x=tree_density,fill=data)) + geom_density(alpha=0.3) + facet_wrap(~site,scales="free") + labs(x="Trees per plot")
combined
ggsave("Sampling_distributions.png",height=4,width=7)
# Chunk 9
#Load data from HPC
f<-list.files(pattern="sampling")
f<-f[str_detect(f,"nlcd")]
fn<-lapply(f,read.csv)
#rename as character
fn<-lapply(fn, function(x){
x$nlcd<-as.character(x$nlcd)
return(x)
})
sampling<-bind_rows(fn)
#remove nlcd classes
to_remove<- sampling %>% filter(nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
ggplot(to_remove,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot(sampling,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot()
sampling<- sampling %>% filter(!nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
#Plot sampling curves
p <- ggplot() + geom_density(data=sampling,aes(x=tree_density,fill=as.factor(year)),alpha=0.4) + facet_wrap(~site,scales="free") + labs(fill="year")
#Get site curve
field_density<-field %>% filter(siteID %in% results$Site) %>% group_by(site=siteID,plotID,eventID) %>% summarize(n=n()) %>% summarize(tree_density=round(mean(n)))
rects<-field_density %>% group_by(site) %>% summarize(mean=mean(tree_density),lower=quantile(tree_density,0.05), upper=quantile(tree_density,0.95))
p +geom_rect(data=rects,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(data=rects,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot",fill="Year")
ggsave("sampling3.png",height=4,width=7)
rect_subset <- rects %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO"))
sampling %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>% group_by(site) %>% filter(year==max(year)) %>% ggplot(.) +
geom_density(aes(x=tree_density),fill="black",alpha=0.4) + facet_wrap(~site,scales="free") +geom_rect(data=rect_subset,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(aes(xintercept=mean(tree_density))) + geom_vline(data=rect_subset,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot")
ggsave("Sampling_subset.png",height=4,width=7)
#as a pair of distributions
field_density$data<-c("NEON Field Plots")
sampling$data<-c("Simulated RS Plots")
combined<-bind_rows(field_density,sampling) %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>%
ggplot(.,aes(x=tree_density,fill=data)) + geom_density(alpha=0.3) + facet_wrap(~site,scales="free") + labs(x="Trees per plot")
combined
ggsave("Sampling_distributions.png",height=4,width=7)
# Chunk 9
#Load data from HPC
f<-list.files(pattern="sampling")
f<-f[str_detect(f,"nlcd")]
fn<-lapply(f,read.csv)
#rename as character
fn<-lapply(fn, function(x){
x$nlcd<-as.character(x$nlcd)
return(x)
})
sampling<-bind_rows(fn)
#remove nlcd classes
to_remove<- sampling %>% filter(nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
ggplot(to_remove,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot(sampling,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot()
sampling<- sampling %>% filter(!nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
#Plot sampling curves
p <- ggplot() + geom_density(data=sampling,aes(x=tree_density,fill=as.factor(year)),alpha=0.4) + facet_wrap(~site,scales="free") + labs(fill="year")
#Get site curve
field_density<-field %>% filter(siteID %in% results$Site) %>% group_by(site=siteID,plotID,eventID) %>% summarize(n=n()) %>% summarize(tree_density=round(mean(n)))
rects<-field_density %>% group_by(site) %>% summarize(mean=mean(tree_density),lower=quantile(tree_density,0.05), upper=quantile(tree_density,0.95))
p +geom_rect(data=rects,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(data=rects,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot",fill="Year")
ggsave("sampling3.png",height=4,width=7)
rect_subset <- rects %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO"))
sampling %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>% group_by(site) %>% filter(year==max(year)) %>% ggplot(.) +
geom_density(aes(x=tree_density),fill="black",alpha=0.4) + facet_wrap(~site,scales="free") +geom_rect(data=rect_subset,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(aes(xintercept=mean(tree_density))) + geom_vline(data=rect_subset,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot")
ggsave("Sampling_subset.png",height=4,width=7)
#as a pair of distributions
field_density$data<-c("NEON Field Plots")
sampling$data<-c("Simulated RS Plots")
combined<-bind_rows(field_density,sampling) %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>%
ggplot(.,aes(x=tree_density,fill=data)) + geom_density(alpha=0.3) + facet_wrap(~site,scales="free") + labs(x="Trees per plot")
combined
ggsave("Sampling_distributions.png",height=4,width=7)
# Chunk 9
#Load data from HPC
f<-list.files(pattern="sampling")
f<-f[str_detect(f,"nlcd")]
fn<-lapply(f,read.csv)
#rename as character
fn<-lapply(fn, function(x){
x$nlcd<-as.character(x$nlcd)
return(x)
})
sampling<-bind_rows(fn)
#remove nlcd classes
to_remove<- sampling %>% filter(nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
ggplot(to_remove,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot(sampling,aes(x=nlcd, y=tree_density)) + geom_boxplot()
ggplot()
sampling<- sampling %>% filter(!nlcd %in% c(11,12,21,22,23,31,32,33,81,82,83,84,85))
#Plot sampling curves
p <- ggplot() + geom_density(data=sampling,aes(x=tree_density,fill=as.factor(year)),alpha=0.4) + facet_wrap(~site,scales="free") + labs(fill="year")
#Get site curve
field_density<-field %>% filter(siteID %in% results$Site) %>% group_by(site=siteID,plotID,eventID) %>% summarize(n=n()) %>% summarize(tree_density=round(mean(n)))
rects<-field_density %>% group_by(site) %>% summarize(mean=mean(tree_density),lower=quantile(tree_density,0.05), upper=quantile(tree_density,0.95))
p +geom_rect(data=rects,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(data=rects,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot",fill="Year")
ggsave("sampling3.png",height=4,width=7)
rect_subset <- rects %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO"))
sampling %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>% group_by(site) %>% filter(year==max(year)) %>% ggplot(.) +
geom_density(aes(x=tree_density),fill="black",alpha=0.4) + facet_wrap(~site,scales="free") +geom_rect(data=rect_subset,aes(xmin=lower,xmax=upper,ymin=0,ymax=Inf),fill="black",alpha=0.2) + geom_vline(aes(xintercept=mean(tree_density))) + geom_vline(data=rect_subset,aes(xintercept=mean),linetype="dashed") + theme_bw() + labs(x="Trees per plot")
ggsave("Sampling_subset.png",height=4,width=7)
#as a pair of distributions
field_density$data<-c("NEON Field Plots")
sampling$data<-c("Simulated RS Plots")
combined<-bind_rows(field_density,sampling) %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","HARV","LENO")) %>%
ggplot(.,aes(x=tree_density,fill=data)) + geom_density(alpha=0.3) + facet_wrap(~site,scales="free") + labs(x="Trees per plot")
combined
ggsave("Sampling_distributions.png",height=4,width=7)
combined<-bind_rows(field_density,sampling) %>% filter(site %in% c("DSNY","TEAK","OSBS","BART","DELA","SJER","JERC","SOAP","LENO")) %>%
ggplot(.,aes(x=tree_density,fill=data)) + geom_density(alpha=0.3) + facet_wrap(~site,scales="free") + labs(x="Trees per plot")
combined
ggsave("Sampling_distributions.png",height=4,width=7)
